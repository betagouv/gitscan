name: Generate Org Summaries

on:
    workflow_dispatch:
        inputs:
            days:
                description: "Number of days to look back for changelogs"
                required: false
                default: "7"
                type: string
    schedule:
        - cron: "0 12 * * 5" # every Friday at 12:00 UTC

concurrency:
    cancel-in-progress: true
    group: org-summaries

jobs:
    generate:
        runs-on: ubuntu-latest
        name: Generate Org Summaries
        steps:
            - uses: actions/checkout@v4

            - name: Generate org summaries
              env:
                  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
                  OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
                  OPENAI_MODEL: ${{ vars.OPENAI_MODEL || 'gemma-3-27b-it' }}
                  DAYS: ${{ inputs.days || '7' }}
              run: |
                  ./scripts/generate-org-summaries.sh

            - name: Commit changes
              run: |
                  git config user.name "BetaBot"
                  git config user.email "infra@incubateur.net"
                  git add ./repos/*/CHANGELOG-generated.md

                  if git diff --staged --quiet; then
                    echo "No changes to commit"
                    exit 0
                  fi

                  git commit -m "update: org summaries"

                  for i in {1..5}; do
                    git pull --rebase --autostash && git push && break
                    echo "Push failed, retrying ($i/5)..."
                    sleep $((i * 2))
                  done
